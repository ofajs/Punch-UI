<template component>
  <l-m src="../wave/wave.html"></l-m>
  <style>
    :host {
      display: block;
      --item-radio: 30px;
    }
    .container {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: stretch;
      /* overflow: auto; */
      overflow: hidden;
    }

    ::slotted(*) {
      position: relative;
      flex: 0 0 0;
      border-radius: var(--item-radio);
      cursor: pointer;
      overflow: hidden;
      color: transparent;
      transition: all ease 0.3s;
    }

    ::slotted(*:last-child) {
      margin-right: 0 !important;
    }

    ::slotted([pos="focus"]) {
      color: inherit;
      outline: red solid 4px;
    }

    .prev,
    .next {
      position: absolute;
      top: 40%;
      z-index: 2;
    }
    .prev {
      left: 0;
    }
    .next {
      right: 0;
    }
  </style>
  <style id="target"></style>
  <div class="container">
    <slot></slot>
    <button class="prev" on:click="toPrev">prev</button>
    <button class="next" on:click="toNext">next</button>
  </div>
  <script>
    export default {
      tag: "p-carousel",
      attrs: {
        mainBasis: null, // 焦点窗口的大小
        activeIndex: "0",
      },
      data: {
        // currentId: 0,
        spaceSize: 6,
        smallBasis: 60, // 小块的尺寸
        // activeLen: 1, // 可以处于激活态的窗口数量
        // mediumSize: null, // 中间的尺寸
        canShowSmall: false, // 是否可以出现小块
      },
      proto: {
        get visoLastId() {
          // 视觉上的最后一个id
          return this.length - this._activeLen;
        },
        get currentId() {
          return parseInt(this.activeIndex) || 0;
        },
        set currentId(val) {
          this.activeIndex = String(val);
        },
        refreshStyle() {
          const styleContent = "";

          // 计算激活宽度
          let mainBasis = parseInt(this.mainBasis);

          if (/%$/.test(this.mainBasis)) {
            mainBasis = (this.width * parseInt(mainBasis)) / 100;
          }

          this._mainBasis = mainBasis;

          // 可以共存的个数
          let activeLen = Math.floor(this.width / mainBasis);
          this._activeLen = activeLen;

          // 剩余的尺寸，如果不足一半，填充为只有一个收缩的格
          const oversize =
            this.width - activeLen * (mainBasis + this.spaceSize);

          this.shadow.$("#target").html = `
          ::slotted([pos="small"]){
            flex-basis:${this.smallBasis}px;
          }
          ::slotted([pos="medium"]){
            flex-basis:${oversize}px;
            margin-right: ${this.spaceSize}px;
          }
          ::slotted([pos="focus"]),::slotted([pos="main"]){
            flex-basis: ${mainBasis}px;
            margin-right: ${this.spaceSize}px;
          }
          `;

          this.repareCurrent();

          console.log("refreshStyle");
        },
        repareCurrent() {
          const oriActiveLen = this._activeLen;

          this.forEach((e, index) => {
            if (this.currentId === index) {
              // 焦点的块
              e.attr("pos", "focus");
              return;
            }

            if (this.currentId + oriActiveLen >= this.length) {
              if (index === this.length - oriActiveLen - 1) {
                e.attr("pos", "medium");
                return;
              }

              if (index >= this.visoLastId) {
                // 已经是尽头，调整前面几个的宽度保持一致
                e.attr("pos", "main");
                return;
              }
            }

            if (
              index > this.currentId &&
              index < this.currentId + oriActiveLen
            ) {
              // 在尺寸范围内，和焦点保持一致的块
              e.attr("pos", "main");
              return;
            }

            if (index === this.currentId + oriActiveLen) {
              e.attr("pos", "medium");
              return;
            }

            e.attr("pos", null);
          });
        },
        toNext() {
          if (this.currentId <= this.length - 2) {
            this.currentId++;
            this.repareCurrent();
          }
        },
        toPrev() {
          if (this.currentId > 0) {
            this.currentId--;
            this.repareCurrent();
          }
        },
      },
      ready() {
        this.shadow.on("slotchange", () => {
          this.forEach((e) => {
            if (!e.$("p-wave")) {
              // 添加 wave 效果
              e.push({ tag: "p-wave" });
            }
          });
        });
      },
      attached() {
        let defaultActiveId = this.attr("default-active-index");

        if (defaultActiveId) {
          this.currentId = parseInt(defaultActiveId);
        }

        this.refreshStyle();
      },
    };
  </script>
</template>
