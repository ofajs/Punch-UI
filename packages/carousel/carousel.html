<template component>
  <l-m src="../wave/wave.html"></l-m>
  <style>
    :host {
      display: block;
      --item-radio: 30px;
    }
    .container {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: stretch;
      /* overflow: auto; */
      overflow: hidden;
    }

    ::slotted(*) {
      position: relative;
      flex: 0 0 0;
      border-radius: var(--item-radio);
      cursor: pointer;
      overflow: hidden;
      color: transparent;
      transition: all ease 0.3s;
    }

    ::slotted(*:last-child) {
      margin-right: 0 !important;
    }

    ::slotted([focus]) {
      color: inherit;
      outline: green solid 4px;
    }
    .prev,
    .next {
      position: absolute;
      top: 40%;
      z-index: 2;
    }
    .prev {
      left: 0;
    }
    .next {
      right: 0;
    }
  </style>
  <div class="container">
    <slot></slot>
    <button class="prev" on:click="currentId--">prev</button>
    <button class="next" on:click="currentId++">next</button>
  </div>
  <script>
    export default {
      tag: "p-carousel",
      attrs: {
        mainBasis: null, // 焦点窗口的大小
        activeIndex: "0", // 激活中的id
        align: "start", // start 左侧第一个为主要块；center 主要块为中间那个
      },
      data: {
        spaceSize: 6,
        smallBasis: 60, //小块的尺寸
      },
      watch: {
        activeIndex() {
          if (this.currentId < 0) {
            this.currentId = 0;
            return;
          }

          if (this.currentId >= this.length) {
            this.currentId = this.length - 1;
            return;
          }
          this.render(this.currentId);
        },
      },
      proto: {
        get currentId() {
          return parseInt(this.activeIndex) || 0;
        },
        set currentId(val) {
          this.activeIndex = String(val);
        },
        // 根据index进度渲染页面
        render(activeId) {
          // 计算激活宽度
          let mainBasis = parseInt(this.mainBasis);

          if (/%$/.test(this.mainBasis)) {
            mainBasis = (this.width * parseInt(mainBasis)) / 100;
          }

          if (!mainBasis) {
            return;
          }

          // 可以共存的个数
          let activeLen = Math.floor(this.width / mainBasis);

          // 视觉上的最后一个id
          // const lastVisoId = this.length - activeLen;

          // 剩余的尺寸
          const oversize =
            this.width - activeLen * (mainBasis + this.spaceSize);

          // 向前修正的个数
          let fixPrevLen = 0;
          // 修正的激活id个数
          let targetId = activeId;

          this.$("[focus]")?.attr("focus", null);
          this[activeId].attr("focus", "");

          for (let i = activeLen; i > 0; i--) {
            const target = this[targetId];

            if (target) {
              target.style.flexBasis = `${mainBasis}px`;
              target.style.marginRight = `${this.spaceSize}px`;
            } else {
              fixPrevLen++;
            }

            targetId++;
          }

          let fixedActiveId = activeId;
          if (fixPrevLen) {
            // 向前面修补数量

            for (let i = fixPrevLen; i > 0; i--) {
              fixedActiveId--;
              const target = this[fixedActiveId];

              target.style.flexBasis = `${mainBasis}px`;
              target.style.marginRight = `${this.spaceSize}px`;
            }
          }

          // 填充剩余的空间
          if (this[targetId]) {
            // 后面还有元素，修正后面的元素
            const nextEl = this[targetId];

            nextEl.style.flexBasis = `${oversize}px`;
          } else {
            // 后面没有元素，修正前一个元素
            const target = this[fixedActiveId - 1];

            target.style.flexBasis = `${oversize}px`;
            target.style.marginRight = `${this.spaceSize}px`;
          }

          console.log(mainBasis, activeLen, oversize, activeId);
        },
      },
      ready() {
        // fix p-wave
        this.shadow.on("slotchange", () => {
          this.forEach((e) => {
            if (!e.$("p-wave")) {
              e.push({ tag: "p-wave" });
            }
          });
        });
      },
      attached() {
        this.render(this.currentId);
      },
    };
  </script>
</template>
