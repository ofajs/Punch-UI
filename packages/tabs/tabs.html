<template component>
  <l-m src="./tab.html"></l-m>
  <style>
    :host {
      position: relative;
      display: block;
      font-size: 14px;
      border-bottom: var(--md-ref-palette-normal60) solid 0.5px;
      overflow: auto;
    }
    .container {
      display: flex;
    }
  </style>

  <inject-host>
    <style>
      p-tabs[secondary] p-tab[active-item] {
        color: var(--md-sys-color-on-primary-container);
      }
    </style>
  </inject-host>

  <x-if :value="inited">
    <style>
      .indicator {
        position: absolute;
        left: 0;
        bottom: 0;
        width: 100px;
        border-bottom: 3px solid var(--md-sys-color-primary);
        border-left: 2px solid transparent;
        border-right: 2px solid transparent;
        transition: left ease 0.3s, width ease 0.3s;
      }

      :host([secondary]) .indicator {
        border-bottom: 2px solid var(--md-sys-color-primary);
        border-left: 0px solid transparent;
        border-right: 0px solid transparent;
      }
    </style>
  </x-if>
  <div class="container">
    <slot></slot>
    <div class="indicator" part="indicator"></div>
  </div>
  <script>
    export default {
      tag: "p-tabs",
      attrs: {
        activeId: 0, // 激活中的id
        secondary: null,
      },
      data: {
        inited: false,
      },
      proto: {
        // 获取底部线的定位和宽度
        getIndicatorPostion(activeId) {
          const target = this[activeId];

          if (target) {
            if (this.secondary !== null) {
              return {
                left: target.ele.offsetLeft,
                width: target.clientWidth,
              };
            }

            if (target.container) {
              const { ele } = target.container;

              return {
                left: target.ele.offsetLeft + ele.offsetLeft,
                width: target.container.width - 4,
              };
            }
          }

          return {
            left: 0,
            width: 0,
          };
        },
        // 修复底部线的定位
        _fixBottomPosition() {
          const target = this[this.activeId];
          if (target && target.container) {
            const { left, width } = this.getIndicatorPostion(this.activeId);

            Object.assign(this.shadow.$(".indicator").style, {
              left: `${left}px`,
              width: `${width}px`,
            });

            this.all("[active-item]").forEach((e) =>
              e.attr("active-item", null)
            );

            target.attr("active-item", "");
          }
        },
      },
      watch: {
        activeId() {
          this._fixBottomPosition();
        },
        secondary(val) {
          if (val !== null) {
            this.forEach((e) => {
              if (e.tag === "p-tab") {
                e.iconPosition = "start";
              }
            });
          }
        },
      },
      attached() {
        requestAnimationFrame(() => {
          setTimeout(() => {
            this._fixBottomPosition();
            this.inited = true;
          }, 50);
        });
      },
      ready() {
        this.on("click-tab-item", (e) => {
          this.activeId = $(e.target).index;
          e.stopPropagation();
        });

        this.shadow.on("slotchange", () => {
          requestAnimationFrame(() => {
            setTimeout(() => {
              this._fixBottomPosition();
              this.inited = true;
            }, 50);
          });
        });
      },
    };
  </script>
</template>
