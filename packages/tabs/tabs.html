<template component>
  <l-m src="./tab.html"></l-m>
  <style>
    :host {
      position: relative;
      display: block;
      font-size: 14px;
      --active-color: var(--md-sys-color-primary);
      border-bottom: var(--md-ref-palette-normal60) solid 0.5px;
    }
    .container {
      display: flex;
    }
  </style>

  <x-if :value="inited">
    <style>
      .indicator {
        position: absolute;
        left: 0;
        bottom: 0;
        width: 100px;
        border-bottom: 3px solid var(--active-color);
        border-left: 2px solid transparent;
        border-right: 2px solid transparent;
        transition: left ease 0.3s, width ease 0.3s;
      }
    </style>
  </x-if>
  <div class="container">
    <slot></slot>
    <div class="indicator" part="indicator"></div>
  </div>
  <script>
    export default {
      tag: "p-tabs",
      attrs: {
        activeId: 0,
        iconPosition: null,
      },
      data: {
        inited: false,
      },
      proto: {
        _fixBottomLine() {
          const target = this[this.activeId];
          if (target && target.container) {
            const { ele } = target.container;

            Object.assign(this.shadow.$(".indicator").style, {
              left: `${ele.offsetLeft - 2}px`,
              width: `${target.container.width}px`,
            });

            this.all("[active-item]").forEach((e) =>
              e.attr("active-item", null)
            );

            target.attr("active-item", "");
          }
        },
      },
      watch: {
        activeId() {
          this._fixBottomLine();
        },
        iconPosition(val) {
          if (val !== null) {
            this.forEach((e) => {
              if (e.tag === "p-tab") {
                e.iconPosition = val;
              }
            });
          }
        },
      },
      attached() {
        requestAnimationFrame(() => {
          setTimeout(() => {
            this._fixBottomLine();
            this.inited = true;
          }, 50);
        });
      },
      ready() {
        this.on("click-tab-item", (e) => {
          this.activeId = $(e.target).index;
          e.stopPropagation();
        });
      },
    };
  </script>
</template>
