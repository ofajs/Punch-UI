<template component>
  <style>
    :host {
      display: inline-block;
      width: 200px;
    }
    .container {
      position: relative;
      height: 4px;
      border-radius: var(--pui-border-radius);
      background-color: var(--pui-main-color-container);
    }
    .rang {
      position: absolute;
      height: 4px;
      border-radius: var(--pui-border-radius);
      background-color: var(--pui-main-color);
    }
    .rang:before {
      display: block;
      content: "";
      position: absolute;
      left: 0;
      top: -13px;
      width: calc(100% + 10px);
      height: 30px;
      /* background-color: rgba(255, 0, 0, 0.244); */
    }
    .cursor {
      position: absolute;
      right: 0;
      top: -8px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      transform: translate(50%, 0);
      background-color: var(--pui-main-color);
      cursor: pointer;
      box-shadow: var(--contained-shadow);
    }
    .cursor:hover {
      box-shadow: var(--contained-hover-shadow);
    }
    .cursor:active {
      box-shadow: var(--contained-active-shadow);
    }

    .bubble {
      position: absolute;
      left: 10px;
      top: -38px;
      box-sizing: border-box;
      display: flex;
      justify-content: center;
      align-items: center;
      min-width: 26px;
      height: 26px;
      padding: 0 var(--pui-space-x);
      border-radius: 14px;
      font-size: 12px;
      z-index: 2;
      opacity: 0;
      color: var(--pui-on-main-color);
      background-color: var(--pui-main-color);
      user-select: none;
      transform: translate(-50%, 10px);
      transition: all ease 0.2s;
    }
    .bubble::after {
      position: absolute;
      bottom: -6px;
      display: block;
      content: "";
      border-top: var(--pui-main-color) solid 10px;
      border-right: transparent solid 9.8px;
      border-left: transparent solid 9.8px;
    }

    .rang:hover .bubble,
    .inmousedown .bubble {
      opacity: 1;
      transform: translate(-50%, 0);
    }
  </style>
  <div class="container" class:inmousedown="inmousedown">
    <div class="rang" attr:style="`width:${rangWidth}`">
      <div class="cursor cursor-end" on:mousedown="mousedown">
        <div class="bubble">{{value}}</div>
      </div>
    </div>
  </div>
  <script>
    import "../init.js";
    import { setMainColor } from "../commons/util.js";
    export default {
      attrs: {
        color: null,
        min: 0,
        max: 100,
        step: 0.5,
        value: 50,
      },
      data: {
        inmousedown: false,
      },
      watch: {
        color(color) {
          if (color) {
            setMainColor(this, color);
          }
        },
      },
      proto: {
        get rangWidth() {
          let num = ((this.value - this.min) / (this.max - this.min)) * 100;
          if (num > 100) {
            num = 100;
          } else if (num < 0) {
            num = 0;
          }

          return num + "%";
        },
        mousedown(e) {
          // clear old binding
          if (this._upFun) {
            this._upFun();
          }

          const width = this.width;
          this.inmousedown = true;

          let startValue = parseFloat(this.value);
          const totalValue = this.max - this.min;
          // console.log("mousedown", e);

          const startX = e.screenX;
          $("body").on(
            "mousemove",
            (this._moveFun = (e2) => {
              const diffX = e2.screenX - startX;
              let value = startValue + (diffX / width) * totalValue;

              // console.log(value);

              let ratio = value / this.step;
              ratio = Math.round(ratio);
              value = ratio * this.step;

              // console.log(value, diffX, width, totalValue, startX);

              if (value > this.max) {
                value = parseFloat(this.max);
              } else if (value < this.min) {
                value = parseFloat(this.min);
              }

              this.value = value;
            })
          );

          $("body").on(
            "mouseup",
            (this._upFun = (e3) => {
              console.log("mouseup");
              $("body").off("mousemove", this._moveFun);
              $("body").off("mouseup", this._upFun);
              $("body").off("mouseleave", this._upFun);
              this._upFun = null;
              this.inmousedown = false;
            })
          );

          $("body").on("mouseleave", this._upFun);
        },
      },
    };
  </script>
</template>
