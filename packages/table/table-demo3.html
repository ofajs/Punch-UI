<template page>
  <l-m src="../button/p-button.html"></l-m>
  <l-m src="./p-table.html"></l-m>
  <l-m src="../checkbox/p-checkbox.html"></l-m>

  <div>
    <p-table step="0.5" style="height: 300px">
      <p-table-row head sticky>
        <p-table-cell col-width="50">
          <p-checkbox
            on:change="changeCheckbox($event,'title')"
            id="titleCheckbox"
          ></p-checkbox>
        </p-table-cell>
        <p-table-cell col-width="150"
          >Name
          <p-button
            icon
            size="small"
            variant="text"
            color="normal"
            style="margin-left: auto"
          >
            <iconify-icon icon="majesticons:filter-line"></iconify-icon>
          </p-button>
        </p-table-cell>
        <p-table-cell min-width="120">Mobile</p-table-cell>
        <p-table-cell min-width="230">Birth</p-table-cell>
        <p-table-cell min-width="100">Money</p-table-cell>
        <p-table-cell min-width="100">Level</p-table-cell>
        <p-table-cell min-width="200" align="center">Address</p-table-cell>
        <p-table-cell align="center" col-width="100" sticky-right
          >Operate</p-table-cell
        >
      </p-table-row>
      <x-fill :value="users">
        <p-table-row>
          <p-table-cell>
            <p-checkbox
              on:change="$host.changeCheckbox($event,$data,$index)"
            ></p-checkbox>
          </p-table-cell>
          <p-table-cell>{{$data.user_name}}</p-table-cell>
          <p-table-cell>{{$data.mobile}}</p-table-cell>
          <p-table-cell>{{$data.birth}}</p-table-cell>
          <p-table-cell>{{$data.money}}</p-table-cell>
          <p-table-cell>{{$data.level}}</p-table-cell>
          <p-table-cell>{{$data.address}}</p-table-cell>
          <p-table-cell>
            <p-button
              color="error"
              size="small"
              variant="text"
              on:click="$host.removeItem($index)"
              >Delete</p-button
            >
          </p-table-cell>
        </p-table-row>
      </x-fill>
    </p-table>
  </div>
  <script>
    export default {
      data: {
        users: [],
      },
      proto: {
        changeCheckbox(event, data, index) {
          if (data === "title") {
            const checked = $(event.target).checked;
            this.shadow
              .all("p-checkbox:not(#titleCheckbox)")
              .forEach((e) => (e.checked = checked));
            return;
          }

          let hasChecked = false;
          let allChecked = true;

          this.shadow.all("p-checkbox:not(#titleCheckbox)").forEach((e) => {
            if (e.checked) {
              hasChecked = true;
            } else {
              allChecked = false;
            }
          });

          const titleCheckbox = this.shadow.$("#titleCheckbox");

          if (hasChecked) {
            if (allChecked) {
              titleCheckbox.indeterminate = null;
              titleCheckbox.checked = true;
              return;
            }
            titleCheckbox.indeterminate = true;
            return;
          }

          titleCheckbox.indeterminate = null;
          titleCheckbox.checked = false;
        },
        removeItem(index) {
          this.users.splice(index, 1);
        },
      },
      async ready() {
        const data = await fetch("./data2.json").then((e) => e.json());

        this.users = data;
      },
    };
  </script>
</template>
