<template component>
  <l-m src="./placement.html"></l-m>
  <style>
    :host {
      display: contents;
    }

    [place-ele] {
      color: var(--tips-color, var(--md-sys-color-normal-container));
      background-color: var(
        --tips-bg-color,
        var(--md-sys-color-on-normal-container)
      );
      pointer-events: none;
      visibility: hidden;
      opacity: 0;
      font-size: 12px;
      line-height: 1.3em;
      border-radius: var(--pui-border-radius);
      white-space: nowrap;
      z-index: var(--tips-index, 1);
    }

    :host([plain]) [place-ele] {
      background-color: transparent;
      color: inherit;
      margin: 0;
      padding: 0;
    }

    [place-ele].open {
      opacity: 1;
      pointer-events: auto;
      visibility: visible;
    }
  </style>
  <slot></slot>
  <p-placement>
    <div place-ele class="place" class:open="open" attr:placement="placement">
      <slot name="tips"></slot>
    </div>
  </p-placement>
  <script>
    export default {
      tag: "p-tooltips",
      attrs: {
        placement: null,
        event: null,
      },
      data: {
        open: false,
      },
      watch: {
        open() {
          if (this.open) {
            this._refreshPosition();
          }
        },
        event() {
          this._init();
        },
      },
      proto: {
        openTips() {
          let isDisabled = false;
          this.forEach((element) => {
            if (element.attr("slot") === null && element.disabled) {
              isDisabled = true;
            }
          });
          if (!isDisabled) {
            clearTimeout(this._timer);
            this.open = true;
          }
        },
        closeTips() {
          this._timer = setTimeout(() => {
            this.open = false;
          }, 100);
        },
        _refreshPosition(isInit) {
          const placement = this.shadow.$("p-placement");
          if (!placement._refreshPosition) {
            return;
          }
          const f = () => {
            placement._refreshPosition(this.$(':not([slot="tips"])'));
          };

          f();
        },
        _offBinding() {
          (this.__binding || []).forEach(([name, func]) => {
            if (name && func) {
              this.off(name, func);
            } else {
              name();
            }
          });
        },
        _init() {
          const binding = this.__binding || (this.__binding = []);
          this._offBinding();

          if (!this.event) {
            let f1, f2;
            this.on(
              "mouseenter",
              (f1 = () => {
                this.openTips();
              })
            );
            this.on(
              "mouseleave",
              (f2 = () => {
                this.closeTips();
              })
            );
            binding.push(["mouseenter", f1], ["mouseleave", f2]);
          } else {
            let f1;
            this.on(
              this.event,
              (f1 = () => {
                this.openTips();
              })
            );

            binding.push(["mouseenter", f1], () => {});
          }
        },
      },
      ready() {
        if (this.attr("opened") !== null) {
          this.open = true;
        }
      },
      attached() {
        this._refreshPosition(true);
      },
      detached() {
        this._offBinding();
      },
      loaded() {
        this._refreshPosition(true);
      },
    };
  </script>
</template>
