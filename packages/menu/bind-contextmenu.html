<template component>
  <style>
    :host {
      display: block;
      position: relative;
    }
  </style>
  <slot></slot>
  <script>
    export default async ({ load }) => {
      const { areas } = await load("./menu-area.html");

      return {
        tag: "p-bind-contextmenu",
        attrs: {
          area: null,
        },
        proto: {
          get menu() {
            return this.$("p-menu");
          },
        },
        attached() {
          this.menu.open = "off";

          this.menu.on("contextmenu", (e) => e.stopPropagation());

          this.on("contextmenu", (e) => {
            e.preventDefault();

            this.menu.open = "";

            const { offsetX, offsetY } = e;

            Object.assign(this.menu.style, {
              position: "absolute",
              left: `${offsetX}px`,
              top: `${offsetY}px`,
            });
          });

          if (!this._bindFn) {
            // 点击外部环境后，取消菜单绑定
            $("html").on(
              "click",
              (this._bindFn = () => {
                this.menu.open = "off";

                $("html").off("mouseup", this._bindFn);
                this._bindFn = null;
              })
            );
          }
        },
        detached() {
          if (this._bindFn) {
            $("html").off("mouseup", this._bindFn);
          }
        },
      };
    };
  </script>
</template>
